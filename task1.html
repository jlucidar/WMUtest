<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./libs/css/pure-min.css">
    <link rel="stylesheet" href="./libs/css/style.css">
    <title>WMUtest - Task 1</title>
  </head>
  <body>
    <div class="task1-home">
      <h1>Tâche 1 :</h1>
      <h2>Tâche basée sur celle de Carriedo et al., 2016</h2>
      <div class="pure-g">
        <div class="pure-u-2-3 task1-desc">
          <ul>
            <li>Lors de cette tâche, des images seront présentées et quantifiables en termes de taille.</li>
            <li>Il y a 4 fois 4 listes de 12 images correspondant (cf. tableau 1) à des différents niveaux de :
              <ul>
                <li>charge mémorielle (mots concrets à retenir)</li>
                <li>suppression (possibles mots concrets à retenir, mais qui devront être finalement oubliés)</li>
              </ul>
            Les images complétant la liste sont des images abstraites à ne pas retenir.
            Chacune des listes est présentée aléatoirement.
            </li>

            <li>Il est important de dire oralement les consignes et à quoi correspondent les images lorsqu’elles défilent. Cela afin d’éviter un biais de mauvaise interprétation de l’image.</li>
          </ul>
          <p>
            L’enfant devra rappeler, à la fin de la présentation, les éléments les plus petits (ceux de la charge mémorielle).</br>
            La quantité de mots à rappeler sera indiqué à chaque fois puisqu’elle varie.
          </p>
        </div>
        <div class="pure-u-1-3 table1">
          <table>
            <tr>
              <th colspan="2" rowspan="2">Tableau 1</th>
              <th colspan="2">Charge mémorielle</th>
            </tr>
            <tr>
              <td>Haute</td>
              <td>Faible</td>
            </tr>
            <tr>
              <td rowspan="2">Suppression</td>
              <td>Haute</td>
              <td>4 listes</td>
              <td>4 listes</td>
            </tr>
            <tr>
              <td>Faible</td>
              <td>4 listes</td>
              <td>4 listes</td>
            </tr>
          </table>
        </div>
      </div>
      <div class="pure-g">
        <div class="pure-u-1">
          <button class="pure-button start-task1-button">>> Démarrer <<</button>
        </div>
      </div>
    </div>
    <div class="task1-child-instruction hidden">
        <h1>On va jouer à un jeu !</h1>
        <p>
        Tu vas voir plein d’images, à la fin il faudra que tu me redises <b><u>les 3 images les plus petites.</u></b><br/>
        <br/>
        On va faire un exemple ensemble.<br/>
        Soit bien attentif !<br/>
        Tu es prêt ?<br/>
        <br/>
      </p>
      <div class="pure-g">
        <div class="pure-u-1">
          <button class="pure-button lets-go-task1-button">>> C’est parti ! <<</button>
        </div>
      </div>
    </div>
    <div class="task1-list-container hidden">
      <img class="task1-img"></img>
    </div>
    <div class="task1-question-mark-container hidden">
      ?
    </div>
    <div class="pure-g task1-all-image-container hidden">
    </div>
  </body>
  <script type="text/javascript" src="./libs/js/jquery.min.js"></script>
  <script type="text/javascript" src="./libs/js/async.min.js"></script>
  <script type="text/javascript">
    var fs = require('fs');
    $(document).ready(function(){

      $(".start-task1-button").click(function(e){
        $(".task1-home").addClass("hidden");
        $(".task1-child-instruction").removeClass("hidden");
      });

      $(".lets-go-task1-button").click(function(e){
        $(".task1-child-instruction").addClass("hidden");
        $(".task1-list-container").removeClass("hidden");
        startTask1();
      });
    });

    function startTask1(){
      doTraining('A',5,function(err,result){

      });

    }

    function doTraining(letter,imageCount,callback){
      fs.readdir('./images/task1/training/',function(err,imageList){
        if(err)return console.error(err);

        indexArray = getShuffledArray(imageCount);

        async.eachSeries(indexArray,function(index,cb){
          showImage(1, letter, index, imageList, true, function(){
            cb();
          });
        },function(err){
          if(err)console.error(err);
          displayQuestionMark(function(){
            displayAllImages(1, letter, indexArray, imageList, true, function(){

            });
          });
        });

      });
    }

    function getImagePath(taskNb, letter,imageNb,imageList,training){
      var pathToImages = './images/task'+taskNb+'/' + (training ? 'training/' :'');
      imageNb=("0" + imageNb).slice(-2); // format number to 2 digit format
      var trainingImageRegExp = new RegExp("Ent_"+letter+"_"+imageNb+"_.*\.png",'g');
      var imageFilename = imageList.find(function(filename){return filename.match(trainingImageRegExp);});
      return pathToImages + imageFilename;
    }
    function showImage(taskNb, letter,imageNb,imageList,training,callback){
      var imagePath = getImagePath(1, letter, imageNb, imageList, true);
      $(".task1-img").removeClass("hidden");
      $(".task1-img").attr("src",imagePath);
      setTimeout(displayBlank.bind(this,callback),3000);
    }

    function displayBlank(callback){
      $(".task1-img").addClass("hidden");
      setTimeout(callback,500);
    }

    function displayQuestionMark(callback){
      $(".task1-img").addClass("hidden");
      $(".task1-question-mark-container").removeClass("hidden");
      $(window).keypress(function (e) {
        if (e.keyCode === 0 || e.keyCode === 32) {
          e.preventDefault();
          $(".task1-question-mark-container").addClass("hidden");
          $(window).unbind("keypress");
          callback();
        }
      });
    }

    function displayAllImages(taskNb, letter,indexArray,imageList,training,callback){
      $(".task1-all-image-container").removeClass("hidden");
      async.each(indexArray,function(index,cb){
        var path = getImagePath(taskNb, letter,index,imageList,training);
        html = "<div class='pure-u-1-4'><img src='"+path+"'></div>";
        $(".task1-all-image-container").append(html);
        cb();
      },function(err){
        if(err)console.error(err);
        callback();
      });
    }


    function getShuffledArray(nbCount) {
      var d= new Array(nbCount);
      for (var i=1;i<=nbCount;i++){
        d[i-1]=i;
      }
      for (var c = d.length - 1; c > 0; c--) {
        var b = Math.floor(Math.random() * (c + 1));
        var a = d[c];
        d[c] = d[b];
        d[b] = a;
      }
      return d;
    }

  </script>
</html>
